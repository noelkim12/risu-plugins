<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>WinBox SPA – 프리셋</title>
    <style>
      :root {
        color-scheme: dark;
      }

      body {
        margin: 0;
        background: #0f1116;
        color: #e6e6e6;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      }

      .lnpm-wrap {
        min-height: 100%;
        background: #141823;
      }

      .lnpm-toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 10px 12px;
        border-bottom: 1px solid #2a2f3a;
        background: #10141e;
        position: sticky;
        top: 0;
        z-index: 1;
      }

      .lnpm-title {
        font-weight: 700;
      }

      .lnpm-spacer {
        flex: 1;
      }

      .lnpm-btn {
        padding: 8px 12px;
        border: 1px solid #3a4352;
        background: #0f131a;
        color: #e6e6e6;
        border-radius: 8px;
        cursor: pointer;
      }

      .lnpm-btn:hover {
        background: #18212c;
      }

      /* 리스트 */
      .lnpm-list {
        display: flex;
        flex-direction: column;
      }

      .lnpm-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 16px;
        border-bottom: 1px solid #263040;
        background: #151b25;
        cursor: pointer;
      }

      .lnpm-item:hover {
        background: #1a212e;
      }

      .lnpm-muted {
        font-size: 12px;
        opacity: 0.6;
      }

      /* 폼 */
      .page {
        padding: 12px;
      }

      .lnpm-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 12px;
      }

      .lnpm-field label {
        font-size: 12px;
        opacity: 0.8;
      }

      .lnpm-field input,
      .lnpm-field textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #333a46;
        background: #0f1217;
        color: #e6e6e6;
        border-radius: 8px;
      }
    </style>
  </head>

  <body>
    <script src="./idb_ic.js" async></script>
    <script>
      (() => {
        // ---- 상태 & 유틸
        const STORAGE_KEY = "winbox-presets";
        const DEFAULTS = Array.from({ length: 10 }, (_, i) => ({
          id: i + 1,
          name: `프리셋${i + 1}`,
          author: "",
          quality: "",
          negative: "",
        }));
        const load = () => {
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return [...DEFAULTS];
            const parsed = JSON.parse(raw);
            return DEFAULTS.map((d) => ({
              ...d,
              ...(parsed.find((p) => p.id === d.id) || {}),
            }));
          } catch {
            return [...DEFAULTS];
          }
        };
        let presets = load();
        const save = () =>
          localStorage.setItem(STORAGE_KEY, JSON.stringify(presets));
        const escapeHTML = (s = "") =>
          s.replace(
            /[&<>'"]/g,
            (m) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                "'": "&#39;",
                '"': "&quot;",
              }[m])
          );

        // ---- 라우터 (해시 기반)
        const routes = {
          "/": listView,
          "/edit/:id": editView,
        };
        function parseHash() {
          const h = location.hash.replace(/^#/, "") || "/";
          const parts = h.split("/").filter(Boolean); // ["edit","3"] 또는 []
          if (parts.length === 0) return { path: "/", params: {} };
          if (parts[0] === "edit" && parts[1])
            return { path: "/edit/:id", params: { id: Number(parts[1]) } };
          return { path: "/", params: {} };
        }
        function navigate(to) {
          if (location.hash !== `#${to}`) location.hash = to;
          else render();
        }
        window.addEventListener("hashchange", render);

        // ---- WinBox 하나만 사용
        let appBox;
        const root = document.createElement("div");
        root.className = "lnpm-wrap";
        function ensureApp() {
          if (appBox) return;
          appBox = new WinBox({
            title: "LIGHTBOARD NAI 프리셋",
            x: "5%",
            y: "6%",
            width: "72%",
            height: "80%",
            mount: root,
            background: "#0f131a",
            class: ["no-full", "no-resize", "no-max", "no-min"],
          });
        }

        // ---- View: 리스트
        function listView() {
          root.innerHTML = "";
          const toolbarEl = document.createElement("lnpm-toolbar");
          toolbarEl.config = {
            title: "프리셋 목록",
            right: [{ label: "초기화", onClick: resetAll, danger: false }],
          };
          root.appendChild(toolbarEl);

          const listEl = document.createElement("lnpm-list");
          listEl.data = {
            presets,
            onNavigate: (id) => navigate(`/edit/${id}`),
            filledFlags,
          };
          root.appendChild(listEl);
        }

        function filledFlags(p) {
          const a = p.author?.trim() ? "A" : "-";
          const q = p.quality?.trim() ? "Q" : "-";
          const n = p.negative?.trim() ? "N" : "-";
          return `${a}/${q}/${n}`;
        }

        // ---- View: 편집
        function editView(params) {
          const id = Number(params.id);
          const p = presets.find((x) => x.id === id) || presets[0];

          root.innerHTML = "";
          const toolbarEl = document.createElement("lnpm-toolbar");
          toolbarEl.config = {
            title: `${p.name} 편집`,
            left: [{ label: "← 목록", onClick: () => navigate("/") }],
            right: [
              { label: "저장", onClick: saveCurrent },
              {
                label: "리셋",
                onClick: () => {
                  p.author = "";
                  p.quality = "";
                  p.negative = "";
                  save();
                  render();
                },
              },
            ],
          };
          root.appendChild(toolbarEl);

          const page = document.createElement("div");
          page.className = "lnpm-page";
          page.innerHTML = `
      <div class="lnpm-field">
        <label for="author">author</label>
        <textarea id="author" rows="4" cols="3" placeholder="author:...">${escapeHTML(
          p.author
        )}</textarea>
      </div>
      <div class="lnpm-field">
        <label for="quality">quality</label>
        <textarea id="quality" rows="4" cols="3" placeholder="8k, masterpiece, ultra-detailed">${escapeHTML(
          p.quality
        )}</textarea>
      </div>
      <div class="lnpm-field">
        <label for="negative">negative</label>
        <textarea id="negative" rows="4" cols="3" placeholder="lowres, blurry, extra fingers">${escapeHTML(
          p.negative
        )}</textarea>
      </div>
    `;
          root.appendChild(page);

          // 단축키: Ctrl+S 저장, Esc 목록
          document.onkeydown = (ev) => {
            if ((ev.ctrlKey || ev.metaKey) && ev.key.toLowerCase() === "s") {
              ev.preventDefault();
              saveCurrent();
            }
            if (ev.key === "Escape") navigate("/");
          };

          function saveCurrent() {
            p.author = page.querySelector("#author").value;
            p.quality = page.querySelector("#quality").value;
            p.negative = page.querySelector("#negative").value;
            save();
            // 저장 피드백: 타이틀 깜빡
            appBox.setTitle(`${p.name} 편집 ✓`);
            setTimeout(() => appBox.setTitle(`${p.name} 편집`), 600);
          }
        }

        // ---- 공통: 툴바 (Custom Element)
        class LnpmToolbar extends HTMLElement {
          constructor() {
            super();
            this._title = "";
            this._leftButtons = [];
            this._rightButtons = [];
          }

          set config({ title = "", left = [], right = [] }) {
            this._title = title;
            this._leftButtons = left;
            this._rightButtons = right;
            this.render();
          }

          connectedCallback() {
            this.className = "lnpm-toolbar";
            this.render();
          }

          render() {
            this.innerHTML = "";

            const leftBox = document.createElement("div");
            for (const b of this._leftButtons)
              leftBox.appendChild(this.createButton(b));

            const titleEl = document.createElement("div");
            titleEl.className = "lnpm-title";
            titleEl.textContent = this._title;

            const spacer = document.createElement("div");
            spacer.className = "lnpm-spacer";

            const rightBox = document.createElement("div");
            for (const b of this._rightButtons)
              rightBox.appendChild(this.createButton(b));

            this.appendChild(leftBox);
            this.appendChild(titleEl);
            this.appendChild(spacer);
            this.appendChild(rightBox);
          }

          createButton({ label, onClick }) {
            const el = document.createElement("button");
            el.className = "lnpm-btn";
            el.textContent = label;
            el.onclick = onClick;
            return el;
          }
        }

        customElements.define("lnpm-toolbar", LnpmToolbar);

        // ---- 공통: 리스트 (Custom Element)
        class LnpmList extends HTMLElement {
          constructor() {
            super();
            this._presets = [];
            this._onNavigate = null;
            this._filledFlags = null;
          }

          set data({ presets = [], onNavigate, filledFlags }) {
            this._presets = presets;
            this._onNavigate = onNavigate;
            this._filledFlags = filledFlags;
            this.render();
          }

          connectedCallback() {
            this.className = "lnpm-list";
            this.addEventListener("click", this.handleClick.bind(this));
          }

          handleClick(e) {
            const el = e.target.closest(".lnpm-item");
            if (!el || !this._onNavigate) return;
            this._onNavigate(el.dataset.id);
          }

          render() {
            this.innerHTML = this._presets
              .map(
                (p) => `
            <div class="lnpm-item" data-id="${p.id}">
              <div>${p.name}</div>
              <div class="lnpm-muted">${
                this._filledFlags ? this._filledFlags(p) : ""
              }</div>
            </div>
          `
              )
              .join("");
          }
        }

        customElements.define("lnpm-list", LnpmList);

        // ---- 기타 액션
        function resetAll() {
          if (!confirm("모든 프리셋을 초기 상태로 되돌릴까?")) return;
          presets = [...DEFAULTS];
          save();
          render();
        }

        // ---- 렌더 진입점
        function render() {
          ensureApp();
          const { path, params } = parseHash();
          (routes[path] || listView)(params);
        }

        // 시작: 기본 라우트
        if (!location.hash) location.hash = "#/";
        window.addEventListener("load", render);
      })();
    </script>
  </body>
</html>
