//@name CBS IntelliSense_v0.1
//@display-name CBS IntelliSense_v0.1
//@version 0.1
//@description CBS IntelliSense for RISU AI

// ----------------------------------------------------------------
// LBI 긴빠이
const pluginApis = globalThis.__pluginApis__;
const risuAPI = {
  risuFetch: pluginApis.risuFetch,
  nativeFetch: pluginApis.nativeFetch,
  getArg: pluginApis.getArg,
  getChar: pluginApis.getChar,
  setChar: pluginApis.setChar,
  addProvider: pluginApis.addProvider,
  addRisuScriptHandler: pluginApis.addRisuScriptHandler,
  removeRisuScriptHandler: pluginApis.removeRisuScriptHandler,
  addRisuReplacer: pluginApis.addRisuReplacer,
  removeRisuReplacer: pluginApis.removeRisuReplacer,
  onUnload: pluginApis.onUnload,
  setArg: pluginApis.setArg,
  getDatabase: null,
};

// auto title 플러그인 버그패치 긴빠이 
if (globalThis.__pluginApis__ && globalThis.__pluginApis__.setArg) {
  const originalSetArg = globalThis.__pluginApis__.setArg;
  globalThis.__pluginApis__.setArg = function(arg, value) {
      if (typeof arg !== 'string') {
          return;
      }
      return originalSetArg.call(this, arg, value);
  };
}

(async () => {
  const { getChar, setChar, risuFetch, getArg, onUnload } = globalThis.__pluginApis__;

  let observer = null;
  let roObserver = null;
  let editors = []
  function applyCbsFormatter() {
    let taArr = document.querySelectorAll('.n-scroll textarea');

    taArr.forEach(ta => {
      if ( !ta.classList.contains("cbs-formatter-appended") ) {
        ta.style.minHeight = '160px';
        ta.style.minWidth = '100%'
        ta.style.maxWidth = '100%'
        ta.style.resize = 'both';
        ta.style.scrollbarWidth = 'none';
        ta.spellcheck = false;
        
        let taParent = ta.parentElement;
        taParent.style.minHeight = '160px';
        taParent.style.height = 'auto';
        ta.classList.add('cbs-formatter-appended');

        roObserver = new ResizeObserver(entries => {
          for (const entry of entries) {
            const cr = entry.target.getBoundingClientRect();
            taParent.style.height = (cr.height > 160 ? cr.height : 160) + 'px';
            taParent.style.minHeight = (cr.height > 160 ? cr.height : 160) + 'px';
          }
        });

        roObserver.observe(ta, {
          highlightEnabled: true,
          autocompleteEnabled: false,
          signatureEnabled: false
        }); 
        editors.push(new CBSTextarea(ta));
      }
    })
  }
  
  function startObserver() {
    if (observer) observer.disconnect();
    if (roObserver) roObserver.disconnect();
    observer = new MutationObserver(() => setTimeout(applyCbsFormatter, 500));
    observer.observe(document.body, { childList: true, subtree: true });
    setTimeout(applyCbsFormatter, 500);
  }

  onUnload(() => {
    if (observer) observer.disconnect();
    if (roObserver) roObserver.disconnect();
    editors.forEach(editor => editor.destroy());
    editors = [];
    console.log('CBS Formatter 플러그인이 언로드되었습니다.');
  });
  startObserver();
})();


/* CBS Editor v1.0.0 - Minified */
!function(){"use strict";if("undefined"!=typeof document){const e=document.createElement("style");e.textContent="/**\n * CBS Editor Styles\n * Styling for autocomplete dropdown and other UI elements\n */\n\n/* Autocomplete Dropdown */\n.cbs-autocomplete-dropdown {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;\n  font-size: 13px;\n}\n\n.cbs-autocomplete-item {\n  padding: 8px 12px;\n  cursor: pointer;\n  border-bottom: 1px solid #f0f0f0;\n  transition: background-color 0.15s ease;\n}\n\n.cbs-autocomplete-item:last-child {\n  border-bottom: none;\n}\n\n.cbs-autocomplete-item:hover {\n  background-color: #f5f5f5;\n}\n\n.cbs-autocomplete-item.selected {\n  background-color: #0078d4;\n  color: white;\n}\n\n.cbs-autocomplete-item.selected .cbs-autocomplete-detail {\n  color: rgba(255, 255, 255, 0.9);\n}\n\n.cbs-autocomplete-label {\n  display: flex;\n  align-items: center;\n  gap: 6px;\n  margin-bottom: 4px;\n}\n\n.cbs-autocomplete-label strong {\n  font-size: 14px;\n  font-weight: 600;\n}\n\n.cbs-block-badge {\n  display: inline-block;\n  background: #ff6b9d;\n  color: white;\n  font-size: 10px;\n  font-weight: bold;\n  padding: 2px 5px;\n  border-radius: 3px;\n  line-height: 1;\n}\n\n.cbs-autocomplete-item.selected .cbs-block-badge {\n  background: rgba(255, 255, 255, 0.3);\n}\n\n.cbs-args {\n  font-size: 12px;\n  color: #666;\n  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;\n}\n\n.cbs-autocomplete-item.selected .cbs-args {\n  color: rgba(255, 255, 255, 0.8);\n}\n\n.cbs-autocomplete-detail {\n  font-size: 12px;\n  color: #888;\n  line-height: 1.4;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n}\n\n/* Signature Help Tooltip */\n.cbs-signature-tooltip {\n  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;\n  font-size: 13px;\n  background: white;\n  color: #333;\n}\n\n.cbs-signature-main {\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n}\n\n.cbs-signature-label {\n  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;\n  font-size: 13px;\n  line-height: 1.4;\n  font-weight: 600;\n}\n\n.cbs-func-name {\n  color: #0078d4;\n  font-weight: 600;\n}\n\n.cbs-param {\n  color: #666;\n}\n\n.cbs-active-param {\n  color: #0078d4;\n  font-weight: bold;\n  background: #e7f3ff;\n  padding: 2px 4px;\n  border-radius: 2px;\n}\n\n.cbs-signature-doc {\n  font-size: 12px;\n  color: #666;\n  line-height: 1.4;\n  padding-top: 6px;\n  border-top: 1px solid #e0e0e0;\n  white-space: pre-line;\n}\n\n.cbs-param-doc {\n  font-size: 12px;\n  color: #333;\n  line-height: 1.4;\n  padding: 6px 8px;\n  background: #f5f5f5;\n  border-radius: 3px;\n  border-left: 3px solid #0078d4;\n}\n\n.cbs-param-doc strong {\n  color: #0078d4;\n}\n\n/* Scrollbar styling for autocomplete dropdown */\n.cbs-autocomplete-dropdown::-webkit-scrollbar {\n  width: 8px;\n}\n\n.cbs-autocomplete-dropdown::-webkit-scrollbar-track {\n  background: #f1f1f1;\n}\n\n.cbs-autocomplete-dropdown::-webkit-scrollbar-thumb {\n  background: #888;\n  border-radius: 4px;\n}\n\n.cbs-autocomplete-dropdown::-webkit-scrollbar-thumb:hover {\n  background: #555;\n}\n",document.head.appendChild(e)}const CBSDatabase=function(){const e={};function t(t){e[t.name.toLowerCase()]=t;for(const a of t.aliases)e[a.toLowerCase()]=t}return t({name:"previous_char_chat",description:"이전 캐릭터 메시지를 반환합니다",aliases:["previouscharchat","lastcharmessage"],arguments:[],example:"{{previous_char_chat}}"}),t({name:"previous_user_chat",description:"이전 사용자 메시지를 반환합니다",aliases:["previoususerchat","lastusermessage"],arguments:[],example:"{{previous_user_chat}}"}),t({name:"char",description:"캐릭터의 이름 또는 별명을 반환합니다",aliases:["bot"],arguments:[],example:"{{char}}"}),t({name:"user",description:"사용자의 이름을 반환합니다",aliases:[],arguments:[],example:"{{user}}"}),t({name:"personality",description:"캐릭터의 페르소나를 반환합니다",aliases:["char_persona","charpersona"],arguments:[],example:"{{personality}}"}),t({name:"description",description:"캐릭터의 설명을 반환합니다",aliases:["char_desc","chardesc"],arguments:[],example:"{{description}}"}),t({name:"scenario",description:"캐릭터의 시나리오를 반환합니다",aliases:[],arguments:[],example:"{{scenario}}"}),t({name:"example_dialogue",description:"캐릭터의 예시 대화를 반환합니다",aliases:["example_message","exampledialogue","examplemessage"],arguments:[],example:"{{example_dialogue}}"}),t({name:"persona",description:"사용자의 페르소나를 반환합니다",aliases:["user_persona","userpersona"],arguments:[],example:"{{persona}}"}),t({name:"main_prompt",description:"메인/시스템 프롬프트를 반환합니다",aliases:["system_prompt","systemprompt","mainprompt"],arguments:[],example:"{{main_prompt}}"}),t({name:"lorebook",description:"로어북/세계관 정보를 반환합니다",aliases:["world_info","worldinfo"],arguments:[],example:"{{lorebook}}"}),t({name:"history",description:"전체 채팅 기록을 반환합니다",aliases:["messages"],arguments:[],example:"{{history}}"}),t({name:"user_history",description:"사용자의 메시지 기록을 반환합니다",aliases:["user_messages","userhistory","usermessages"],arguments:[],example:"{{user_history}}"}),t({name:"char_history",description:"캐릭터의 메시지 기록을 반환합니다",aliases:["char_messages","charhistory","charmessages"],arguments:[],example:"{{char_history}}"}),t({name:"ujb",description:"전역/시스템 노트를 반환합니다",aliases:["global_note","system_note","globalnote","systemnote"],arguments:[],example:"{{ujb}}"}),t({name:"chat_index",description:"현재 채팅 인덱스를 반환합니다",aliases:["chatindex"],arguments:[],example:"{{chat_index}}"}),t({name:"first_msg_index",description:"첫 번째 메시지 인덱스를 반환합니다",aliases:["firstmessageindex","firstmsgindex"],arguments:[],example:"{{first_msg_index}}"}),t({name:"role",description:"메시지 역할을 반환합니다",aliases:[],arguments:[],example:"{{role}}"}),t({name:"lastmessage",description:"마지막 메시지 데이터를 반환합니다",aliases:[],arguments:[],example:"{{lastmessage}}"}),t({name:"lastmessageid",description:"마지막 메시지 인덱스를 반환합니다",aliases:["lastmessageindex"],arguments:[],example:"{{lastmessageid}}"}),t({name:"tempvar",description:"임시 변수를 가져옵니다",aliases:["gettempvar"],arguments:["name"],example:"{{tempvar::myvar}}"}),t({name:"settempvar",description:"임시 변수를 설정합니다",aliases:[],arguments:["name","value"],example:"{{settempvar::myvar::42}}"}),t({name:"return",description:"반환 값을 설정하고 강제 반환합니다",aliases:[],arguments:["value"],example:"{{return::done}}"}),t({name:"getvar",description:"채팅 변수를 가져옵니다",aliases:[],arguments:["name"],example:"{{getvar::score}}"}),t({name:"setvar",description:"채팅 변수를 설정합니다",aliases:[],arguments:["name","value"],example:"{{setvar::score::10}}"}),t({name:"addvar",description:"채팅 변수에 값을 더합니다",aliases:[],arguments:["name","value"],example:"{{addvar::score::1}}"}),t({name:"setdefaultvar",description:"변수가 설정되지 않은 경우 기본값을 설정합니다",aliases:[],arguments:["name","value"],example:"{{setdefaultvar::score::5}}"}),t({name:"getglobalvar",description:"전역 채팅 변수를 가져옵니다",aliases:[],arguments:["name"],example:"{{getglobalvar::total}}"}),t({name:"equal",description:"두 값이 같은지 확인합니다",aliases:[],arguments:["a","b"],example:"{{equal::1::1}} 또는 {{equal::{{user}}::Alice}}"}),t({name:"not_equal",description:"두 값이 다른지 확인합니다",aliases:["notequal"],arguments:["a","b"],example:"{{not_equal::1::2}}"}),t({name:"greater",description:"a가 b보다 큰지 확인합니다",aliases:[],arguments:["a","b"],example:"{{greater::5::3}}"}),t({name:"less",description:"a가 b보다 작은지 확인합니다",aliases:[],arguments:["a","b"],example:"{{less::2::3}}"}),t({name:"greater_equal",description:"a가 b보다 크거나 같은지 확인합니다",aliases:["greaterequal"],arguments:["a","b"],example:"{{greater_equal::3::3}}"}),t({name:"less_equal",description:"a가 b보다 작거나 같은지 확인합니다",aliases:["lessequal"],arguments:["a","b"],example:"{{less_equal::2::3}}"}),t({name:"and",description:"두 값의 논리 AND 연산을 수행합니다",aliases:[],arguments:["a","b"],example:"{{and::1::1}} 또는 {{and::{{equal::{{user}}::Alice}}::{{greater::{{getvar::score}}::10}}}}"}),t({name:"or",description:"두 값의 논리 OR 연산을 수행합니다",aliases:[],arguments:["a","b"],example:"{{or::1::0}} 또는 {{or::{{equal::{{char}}::Bob}}::{{equal::{{char}}::Alice}}}}"}),t({name:"not",description:"값의 논리 NOT 연산을 수행합니다",aliases:[],arguments:["a"],example:"{{not::1}} 또는 {{not::{{equal::{{getvar::flag}}::0}}}}"}),t({name:"all",description:"모든 값이 1인지 확인합니다",aliases:[],arguments:["array","..."],example:"{{all::1::1::1}} 또는 {{all::{{equal::{{user}}::Alice}}::{{greater::{{getvar::level}}::5}}}}"}),t({name:"any",description:"하나 이상의 값이 1인지 확인합니다",aliases:[],arguments:["array","..."],example:"{{any::0::1::0}} 또는 {{any::{{equal::{{user}}::Alice}}::{{equal::{{user}}::Bob}}}}"}),t({name:"iserror",description:"문자열이 오류인지 확인합니다",aliases:[],arguments:["string"],example:"{{iserror::Error: Something}}"}),t({name:"startswith",description:"문자열이 특정 문자열로 시작하는지 확인합니다",aliases:[],arguments:["string","prefix"],example:"{{startswith::hello::he}}"}),t({name:"endswith",description:"문자열이 특정 문자열로 끝나는지 확인합니다",aliases:[],arguments:["string","suffix"],example:"{{endswith::hello::lo}}"}),t({name:"contains",description:"문자열이 특정 문자열을 포함하는지 확인합니다",aliases:[],arguments:["string","substring"],example:"{{contains::hello::el}}"}),t({name:"replace",description:"문자열에서 모든 일치하는 항목을 대체합니다",aliases:[],arguments:["string","target","replacement"],example:"{{replace::hello::l::r}} 또는 {{replace::{{user}}'s sword::sword::shield}}"}),t({name:"split",description:"문자열을 배열로 분할합니다",aliases:[],arguments:["string","delimiter"],example:"{{split::a,b,c::,}} 또는 {{split::Alice|Bob|Charlie::|}}}"}),t({name:"join",description:"배열을 문자열로 결합합니다",aliases:[],arguments:["array","delimiter"],example:"{{join::[a,b,c]::,}}"}),t({name:"spread",description:"배열을 :: 구분자로 펼칩니다",aliases:[],arguments:["array"],example:"{{spread::[a,b,c]}}"}),t({name:"trim",description:"문자열의 공백을 제거합니다",aliases:[],arguments:["string"],example:"{{trim:: hello }} 또는 {{upper::{{trim:: {{user}} }}}}"}),t({name:"length",description:"문자열의 길이를 반환합니다",aliases:[],arguments:["string"],example:"{{length::hello}}"}),t({name:"lower",description:"문자열을 소문자로 변환합니다",aliases:[],arguments:["string"],example:"{{lower::HELLO}}"}),t({name:"upper",description:"문자열을 대문자로 변환합니다",aliases:[],arguments:["string"],example:"{{upper::hello}}"}),t({name:"capitalize",description:"첫 글자를 대문자로 변환합니다",aliases:[],arguments:["string"],example:"{{capitalize::hello}}"}),t({name:"tonumber",description:"문자열에서 숫자를 추출합니다",aliases:[],arguments:["string"],example:"{{tonumber::a1b2c3}}"}),t({name:"arraylength",description:"배열의 길이를 반환합니다",aliases:["array_length"],arguments:["array"],example:'{{arrayelement::["a","b","c"]::1}} → b'}),t({name:"arrayelement",description:"인덱스로 배열 요소를 가져옵니다",aliases:["array_element"],arguments:["array","index"],example:"{{arrayelement::[a,b,c]::1}}"}),t({name:"arrayshift",description:"배열에서 첫 번째 요소를 제거합니다",aliases:["array_shift"],arguments:["array"],example:"{{arrayshift::[a,b,c]}}"}),t({name:"arraypop",description:"배열에서 마지막 요소를 제거합니다",aliases:["array_pop"],arguments:["array"],example:"{{arraypop::[a,b,c]}}"}),t({name:"arraypush",description:"배열에 값을 추가합니다",aliases:["array_push"],arguments:["array","value"],example:"{{arraypush::[a,b]::c}}"}),t({name:"arraysplice",description:"배열을 분할합니다",aliases:["array_splice"],arguments:["array","start","deleteCount","item"],example:"{{arraysplice::[a,b,c]::1::1::x}} 또는 {{arraysplice::[1,2,3,4]::2::2}}"}),t({name:"arrayassert",description:"배열의 인덱스에 값이 있는지 확인합니다",aliases:["array_assert"],arguments:["array","index","value"],example:"{{arrayassert::[a]::2::b}}"}),t({name:"makearray",description:"인자들로 배열을 생성합니다",aliases:["array","a","make_array"],arguments:["item1","item2","..."],example:"{{makearray::a::b::c}} 또는 {{makearray::{{user}}::{{char}}::{{getvar::npc}}}}"}),t({name:"filter",description:"배열을 필터링합니다 (unique: 중복 제거, nonempty: 빈 값 제거, all: 모두)",aliases:[],arguments:["array","type"],example:"{{filter::[a,,b,a]::unique}} 또는 {{filter::[a,,b,,c]::nonempty}} 또는 {{filter::[x,,y,x,z]::all}}"}),t({name:"range",description:"범위 배열을 생성합니다",aliases:[],arguments:["start","end","step"],example:"{{range::0::5::1}}"}),t({name:"dictelement",description:"키로 딕셔너리/객체 요소를 가져옵니다",aliases:["dict_element","objectelement","object_element"],arguments:["dict","key"],example:'{{dictelement::{"name":"John"}::name}} → John'}),t({name:"object_assert",description:"객체에 키가 있는지 확인합니다",aliases:["dict_assert","dictassert","objectassert"],arguments:["dict","key","value"],example:"{{object_assert::{}::a::1}}"}),t({name:"element",description:"JSON에서 중첩된 요소를 가져옵니다",aliases:["ele"],arguments:["json","key1","key2","..."],example:'{{element::{"user":{"name":"John"}}::user::name}} → John'}),t({name:"makedict",description:"key=value 쌍으로 딕셔너리/객체를 생성합니다",aliases:["dict","d","make_dict","makeobject","object","o","make_object"],arguments:["key1=value1","key2=value2","..."],example:"{{makedict::a=1::b=2}}"}),t({name:"calc",description:"문자열 표현식을 계산합니다",aliases:[],arguments:["expression"],example:"{{calc::2+2}} 또는 {{calc::{{getvar::hp}} - 10}} 또는 {{calc::(5 + 3) * 2}}"}),t({name:"round",description:"숫자를 반올림합니다",aliases:[],arguments:["number"],example:"{{round::3.6}}"}),t({name:"floor",description:"숫자를 내림합니다",aliases:[],arguments:["number"],example:"{{floor::3.6}}"}),t({name:"ceil",description:"숫자를 올림합니다",aliases:[],arguments:["number"],example:"{{ceil::3.1}}"}),t({name:"abs",description:"절대값을 반환합니다",aliases:[],arguments:["number"],example:"{{abs::-5}}"}),t({name:"remaind",description:"나머지 연산을 수행합니다",aliases:[],arguments:["a","b"],example:"{{remaind::5::2}} 또는 {{remaind::{{chat_index}}::3}}"}),t({name:"pow",description:"거듭제곱 연산을 수행합니다",aliases:[],arguments:["base","exponent"],example:"{{pow::2::3}} 또는 {{calc::{{pow::{{getvar::level}}::2}} * 10}}"}),t({name:"min",description:"최소값을 반환합니다",aliases:[],arguments:["array","..."],example:"{{min::1::2::3}}"}),t({name:"max",description:"최대값을 반환합니다",aliases:[],arguments:["array","..."],example:"{{max::1::2::3}}"}),t({name:"sum",description:"값들의 합계를 반환합니다",aliases:[],arguments:["array","..."],example:"{{sum::1::2::3}}"}),t({name:"average",description:"값들의 평균을 반환합니다",aliases:[],arguments:["array","..."],example:"{{average::1::2::3}}"}),t({name:"fixnum",description:"숫자를 소수점 자리수로 고정합니다",aliases:["fix_num","fixnumber","fix_number"],arguments:["number","decimals"],example:"{{fixnum::3.14159::2}}"}),t({name:"randint",description:"범위 내의 랜덤 정수를 생성합니다",aliases:[],arguments:["min","max"],example:"{{randint::1::10}}"}),t({name:"dice",description:"NdM 표기법으로 주사위를 굴립니다",aliases:[],arguments:["NdM"],example:"{{dice::2d6}}"}),t({name:"fromhex",description:"16진수를 10진수로 변환합니다",aliases:[],arguments:["hex"],example:"{{fromhex::1a}}"}),t({name:"tohex",description:"10진수를 16진수로 변환합니다",aliases:[],arguments:["number"],example:"{{tohex::26}}"}),t({name:"message_time",description:"메시지의 시간을 반환합니다",aliases:["messagetime"],arguments:[],example:"{{message_time}}"}),t({name:"message_date",description:"메시지의 날짜를 반환합니다",aliases:["messagedate"],arguments:[],example:"{{message_date}}"}),t({name:"message_unixtime_array",description:"메시지 유닉스 시간 배열을 반환합니다",aliases:["messageunixtimearray"],arguments:[],example:"{{message_unixtime_array}}"}),t({name:"unixtime",description:"현재 유닉스 시간을 반환합니다",aliases:[],arguments:[],example:"{{unixtime}}"}),t({name:"time",description:"현재 시간을 반환합니다",aliases:[],arguments:[],example:"{{time}}"}),t({name:"date",description:"날짜/시간을 형식화합니다 (Moment.js 형식)",aliases:["datetimeformat","date_time_format"],arguments:["format","timestamp"],example:"{{date::YYYY-MM-DD::1620000000000}} 또는 {{date::HH:mm:ss::{{unixtime}}}} 또는 {{date::MMMM Do YYYY, h:mm a::{{unixtime}}}}"}),t({name:"isotime",description:"현재 UTC 시간을 반환합니다",aliases:[],arguments:[],example:"{{isotime}}"}),t({name:"isodate",description:"현재 UTC 날짜를 반환합니다",aliases:[],arguments:[],example:"{{isodate}}"}),t({name:"message_idle_duration",description:"마지막 두 사용자 메시지 사이의 유휴 시간을 반환합니다",aliases:["messageidleduration"],arguments:[],example:"{{message_idle_duration}}"}),t({name:"idle_duration",description:"마지막 메시지 이후의 유휴 시간을 반환합니다",aliases:["idleduration"],arguments:[],example:"{{idle_duration}}"}),t({name:"asset",description:"이름으로 에셋 이미지를 반환합니다",aliases:[],arguments:["name"],example:"{{asset::image.png}}"}),t({name:"emotion",description:"이름으로 감정 이미지를 반환합니다",aliases:[],arguments:["name"],example:"{{emotion::happy}}"}),t({name:"audio",description:"이름으로 오디오를 반환합니다",aliases:[],arguments:["name"],example:"{{audio::sound.mp3}}"}),t({name:"bg",description:"100% 너비와 높이로 이미지를 반환합니다 (배경용)",aliases:[],arguments:["name"],example:"{{bg::image.png}}"}),t({name:"video",description:"이름으로 비디오를 반환합니다",aliases:[],arguments:["name"],example:"{{video::video.mp4}}"}),t({name:"video-img",description:"이미지처럼 스타일이 지정된 비디오를 반환합니다",aliases:[],arguments:["name"],example:"{{video-img::video.mp4}}"}),t({name:"path",description:"파일 경로 문자열을 반환합니다",aliases:["raw"],arguments:["name"],example:"{{path::image.png}}"}),t({name:"image",description:"이름으로 이미지를 반환합니다",aliases:[],arguments:["name"],example:"{{image::image.png}}"}),t({name:"img",description:"스타일 없이 이미지를 반환합니다",aliases:[],arguments:["name"],example:"{{img::image.png}}"}),t({name:"bgm",description:"숨겨진 오디오를 반환합니다 (배경음악용)",aliases:[],arguments:["name"],example:"{{bgm::sound.mp3}}"}),t({name:"inlay",description:"인레이 데이터에서 이미지를 반환합니다",aliases:[],arguments:["name"],example:"{{inlay::image.png}}"}),t({name:"inlayed",description:"스타일이 지정된 인레이 데이터에서 이미지를 반환합니다",aliases:[],arguments:["name"],example:"{{inlayed::image.png}}"}),t({name:"inlayeddata",description:"스타일과 데이터가 포함된 인레이 이미지를 반환합니다 (AI에 전송됨)",aliases:[],arguments:["name"],example:"{{inlayeddata::image.png}}"}),t({name:"emotionlist",description:"감정 이름 목록을 반환합니다",aliases:[],arguments:[],example:"{{emotionlist}}"}),t({name:"assetlist",description:"에셋 이름 목록을 반환합니다",aliases:[],arguments:[],example:"{{assetlist}}"}),t({name:"random",description:"인자 중 하나를 랜덤하게 선택합니다",aliases:[],arguments:["arg1","arg2","arg3","..."],example:"{{random::a::b::c}}"}),t({name:"pick",description:"random과 같지만 메시지 인덱스로 시드가 고정되어 일관된 출력을 제공합니다",aliases:[],arguments:["arg1","arg2","arg3","..."],example:"{{pick::a::b::c}}"}),t({name:"roll",description:"1부터 지정된 숫자까지 랜덤 정수를 반환합니다",aliases:[],arguments:["number"],example:"{{roll::6}}"}),t({name:"rollp",description:"roll과 같지만 메시지 인덱스로 시드가 고정되어 일관된 출력을 제공합니다",aliases:[],arguments:["number"],example:"{{rollp::6}}"}),t({name:"hash",description:"문자열을 해시합니다",aliases:[],arguments:["string"],example:"{{hash::hello}}"}),t({name:"blank",description:"빈 문자열을 반환합니다",aliases:["none"],arguments:[],example:"{{blank}}"}),t({name:"br",description:"개행(줄바꿈) 문자를 반환합니다",aliases:["newline"],arguments:[],example:"{{br}}"}),t({name:"cbr",description:"리터럴 개행 문자열을 반환합니다",aliases:["cnl","cnewline"],arguments:[],example:"{{cbr}}"}),t({name:"decbo",description:"특수 여는 중괄호 문자를 반환합니다",aliases:["displayescapedcurlybracketopen"],arguments:[],example:"{{decbo}}"}),t({name:"decbc",description:"특수 닫는 중괄호 문자를 반환합니다",aliases:["displayescapedcurlybracketclose"],arguments:[],example:"{{decbc}}"}),t({name:"bo",description:"이중 여는 중괄호 문자를 반환합니다",aliases:["ddecbo","doubledisplayescapedcurlybracketopen"],arguments:[],example:"{{bo}}"}),t({name:"bc",description:"이중 닫는 중괄호 문자를 반환합니다",aliases:["ddecbc","doubledisplayescapedcurlybracketclose"],arguments:[],example:"{{bc}}"}),t({name:"model",description:"현재 AI 모델을 반환합니다",aliases:[],arguments:[],example:"{{model}}"}),t({name:"axmodel",description:"서브모델을 반환합니다",aliases:[],arguments:[],example:"{{axmodel}}"}),t({name:"isfirstmsg",description:"첫 번째 메시지이면 1, 아니면 0을 반환합니다",aliases:["is_first_msg","is_first_message","isfirstmessage"],arguments:[],example:"{{isfirstmsg}}"}),t({name:"maxcontext",description:"최대 컨텍스트 값을 반환합니다",aliases:[],arguments:[],example:"{{maxcontext}}"}),t({name:"prefill_supported",description:"프리필이 지원되면 1을 반환합니다",aliases:["prefillsupported","prefill"],arguments:[],example:"{{prefill_supported}}"}),t({name:"screen_width",description:"화면 너비를 반환합니다",aliases:["screenwidth"],arguments:[],example:"{{screen_width}}"}),t({name:"screen_height",description:"화면 높이를 반환합니다",aliases:["screenheight"],arguments:[],example:"{{screen_height}}"}),t({name:"button",description:"버튼을 생성합니다",aliases:[],arguments:["label","action"],example:"{{button::Click Me::trigger_command}}"}),t({name:"risu",description:"Risu 로고 이미지를 삽입합니다",aliases:[],arguments:["size"],example:"{{risu::60}}"}),t({name:"file",description:"파일을 표시하거나 base64를 디코드합니다",aliases:[],arguments:["name","base64data"],example:"{{file::filename.txt::YmFzZTY0}}"}),t({name:"previous_chat_log",description:"인덱스로 이전 채팅 로그를 가져옵니다",aliases:[],arguments:["index"],example:"{{previous_chat_log::2}}"}),t({name:"unicode_encode",description:"문자의 유니코드 코드를 가져옵니다",aliases:["unicodeencode"],arguments:["string","index"],example:"{{unicode_encode::A}}"}),t({name:"unicode_decode",description:"유니코드 코드를 문자로 디코드합니다",aliases:["unicodedecode"],arguments:["code"],example:"{{unicode_decode::65}}"}),t({name:"u",description:"16진수에서 유니코드를 디코드합니다",aliases:["unicodedecodefromhex"],arguments:["hex"],example:"{{u::41}}"}),t({name:"ue",description:"16진수에서 유니코드를 인코드합니다",aliases:["unicodeencodefromhex"],arguments:["hex"],example:"{{ue::41}}"}),t({name:"metadata",description:"메타데이터 값을 가져옵니다 (mobile, local, node, version, lang 등)",aliases:[],arguments:["key"],example:"{{metadata::version}}"}),t({name:"module_enabled",description:"모듈이 활성화되었는지 확인합니다",aliases:["moduleenabled"],arguments:["namespace"],example:"{{module_enabled::modulename}}"}),t({name:"module_assetlist",description:"모듈에서 에셋 목록을 가져옵니다",aliases:["moduleassetlist"],arguments:["namespace"],example:"{{module_assetlist::modulename}}"}),t({name:"?",description:"수학 연산을 수행합니다 (+ - * / ^ % < > <= >= || && == != ! 지원)",aliases:[],arguments:["expression"],example:"{{? 1 + 2 * 6}}"}),t({name:"slot",description:"반복 중인 현재 요소를 반환합니다. 인자 없이 사용하면 컨텍스트에 따라 다른 값을 반환하고, 이름을 지정하면 해당 이름의 슬롯 값을 반환합니다",aliases:[],arguments:["name?"],example:"{{slot}} 또는 {{slot::name}}"}),t({name:"xor",description:"XOR 암호를 사용하여 문자열을 암호화하고 base64로 인코딩합니다 (0xFF 키 사용)",aliases:["xorencrypt","xorencode","xore"],arguments:["string"],example:"{{xor::hello}} 또는 {{xor::{{getvar::secret}}}}"}),t({name:"xordecrypt",description:"base64로 인코딩된 XOR 암호화 문자열을 원본 텍스트로 복호화합니다",aliases:["xordecode","xord"],arguments:["base64string"],example:"{{xordecrypt::aGVsbG8=}} 또는 {{xordecrypt::{{getvar::encrypted}}}}"}),t({name:"crypt",description:"사용자 정의 시프트 값으로 카이사르 암호 암호화/복호화를 적용합니다 (기본값: 32768). 기본 시프트를 사용하면 암호화와 복호화 모두에 사용할 수 있습니다",aliases:["crypto","caesar","encrypt","decrypt"],arguments:["string","shift?"],example:"{{crypt::hello}} 또는 {{crypt::hello::1000}} 또는 {{crypt::{{crypt::message}}}} (암호화 후 복호화)"}),t({name:"reverse",description:"입력 문자열을 거꾸로 뒤집습니다",aliases:[],arguments:["string"],example:"{{reverse::hello}} 또는 {{reverse::{{user}}}}"}),t({name:"comment",description:"코드 주석을 위한 CBS 함수입니다. 채팅에 표시되지만 처리되지 않습니다",aliases:[],arguments:["text"],example:"{{comment::이것은 주석입니다}} 또는 {{comment::TODO: 나중에 수정}}"}),t({name:"displayescapedbracketopen",description:"여는 괄호 (를 표시하지만 파싱에 영향을 주지 않는 특수 유니코드 문자를 반환합니다",aliases:["debo","("],arguments:[],example:"{{displayescapedbracketopen}}"}),t({name:"displayescapedbracketclose",description:"닫는 괄호 )를 표시하지만 파싱에 영향을 주지 않는 특수 유니코드 문자를 반환합니다",aliases:["debc",")"],arguments:[],example:"{{displayescapedbracketclose}}"}),t({name:"displayescapedanglebracketopen",description:"여는 꺾쇠괄호 <를 표시하지만 HTML 파싱에 영향을 주지 않는 특수 유니코드 문자를 반환합니다",aliases:["deabo","<"],arguments:[],example:"{{displayescapedanglebracketopen}}"}),t({name:"displayescapedanglebracketclose",description:"닫는 꺾쇠괄호 >를 표시하지만 HTML 파싱에 영향을 주지 않는 특수 유니코드 문자를 반환합니다",aliases:["deabc",">"],arguments:[],example:"{{displayescapedanglebracketclose}}"}),t({name:"displayescapedcolon",description:"콜론 :을 표시하지만 CBS 인자 구분자로 파싱되지 않는 특수 유니코드 문자를 반환합니다",aliases:["dec",":"],arguments:[],example:"{{displayescapedcolon}}"}),t({name:"displayescapedsemicolon",description:"세미콜론 ;을 표시하지만 파싱에 영향을 주지 않는 특수 유니코드 문자를 반환합니다",aliases:[";"],arguments:[],example:"{{displayescapedsemicolon}}"}),t({name:"chardisplayasset",description:"미리 빌드된 에셋 제외 설정으로 필터링된 캐릭터 표시 에셋 이름의 JSON 배열을 반환합니다",aliases:[],arguments:[],example:"{{chardisplayasset}}"}),t({name:"source",description:'사용자 또는 캐릭터의 프로필 이미지 소스 URL을 반환합니다. 인자는 "user" 또는 "char"이어야 합니다',aliases:[],arguments:["type"],example:"{{source::user}} 또는 {{source::char}}"}),t({name:"position",description:"@@position <positionName> 데코레이터와 같은 다양한 기능에서 사용할 수 있는 위치를 정의합니다",aliases:[],arguments:["positionName"],example:"{{position::positionName}}"}),t({name:"#if",description:'CBS의 조건문입니다. 1과 "true"는 참이고, 그 외는 거짓입니다. (#when 사용 권장)',aliases:[],arguments:["condition"],example:"{{#if condition}}...{{/if}} ({{#when condition}}...{{/when}} 사용 권장)"}),t({name:"#if_pure",description:'공백 처리를 유지하는 CBS 조건문입니다. 1과 "true"는 참이고, 그 외는 거짓입니다. (#when::keep 사용 권장)',aliases:[],arguments:["condition"],example:"{{#if_pure condition}}...{{/if_pure}} ({{#when::keep::condition}}...{{/when}} 사용 권장)"}),t({name:"#when",description:'CBS의 조건문입니다. 1과 "true"는 참이고, 그 외는 거짓입니다. 다양한 연산자를 지원합니다 (and, or, is, isnot, >, <, >=, <=, not, keep, legacy, var, vis, vnotis, toggle, tis, tnotis)',aliases:[],arguments:["condition","operator?","..."],example:"{{#when condition}}...{{/when}} 또는 {{#when::A::and::B}}...{{/when}} 또는 {{#when::keep::not::condition}}...{{/when}}"}),t({name:":else",description:"CBS의 else 문입니다. {{#when}} 내부에서 사용되어야 합니다. {{#when}}이 여러 줄인 경우 :else는 추가 문자열 없이 별도 줄에 있어야 합니다",aliases:[],arguments:[],example:"{{#when condition}}...{{:else}}...{{/when}}"}),t({name:"#pure",description:"CBS 처리 없이 내용을 표시합니다. 원시 HTML이나 다른 콘텐츠를 파싱 없이 표시할 때 유용합니다. (#puredisplay 사용 권장)",aliases:[],arguments:[],example:"{{#pure}}...{{/pure}} ({{#puredisplay}}...{{/puredisplay}} 사용 권장)"}),t({name:"#puredisplay",description:"CBS 처리 없이 내용을 표시합니다. 원시 HTML이나 다른 콘텐츠를 파싱 없이 표시할 때 유용합니다",aliases:[],arguments:[],example:"{{#puredisplay}}...{{/puredisplay}}"}),t({name:"#each",description:'배열이나 객체를 반복합니다. 객체의 경우 "as key" 구문으로 키에 접근할 수 있습니다',aliases:[":each"],arguments:["array_or_object","as?","key?"],example:"{{#each array}}...{{/each}} 또는 {{#each object as key}}{{slot::key}}...{{/each}}"}),t({name:"//",description:"코드를 주석 처리하는 CBS 주석입니다. 출력에 표시되지 않습니다",aliases:[],arguments:["comment"],example:"{{// 이것은 주석입니다}}"}),t({name:"hiddenkey",description:"로어북 활성화를 위한 키로 작동하지만, 모델 요청에는 포함되지 않습니다",aliases:[],arguments:["value"],example:"{{hiddenkey::some_value}}"}),t({name:"trigger_id",description:'수동 트리거를 발생시킨 클릭된 요소의 risu-id 속성에서 ID 값을 반환합니다. ID가 제공되지 않은 경우 "null"을 반환합니다',aliases:["triggerid"],arguments:[],example:"{{trigger_id}}"}),t({name:"jb",description:"AI 동작을 수정하는 데 사용되는 탈옥(jailbreak) 프롬프트 텍스트를 반환합니다. 텍스트는 변수 치환을 위해 채팅 파서를 통해 처리됩니다",aliases:["jailbreak"],arguments:[],example:"{{jb}}"}),t({name:"jbtoggled",description:'탈옥 프롬프트가 현재 활성화/켜져 있으면 "1"을 반환하고, 비활성화되어 있으면 "0"을 반환합니다. 전역 탈옥 토글 상태를 반영합니다',aliases:[],arguments:[],example:"{{jbtoggled}}"}),{getFunctionInfo(t){const a=(t||"").toLowerCase();return e[a]||null},getAllFunctions(){const t=new Set,a=[];for(const s in e){const n=e[s];t.has(n.name)||(t.add(n.name),a.push(n))}return a},addFunction:t}}(),CBSParser={findCBSContext:function(e,t){const a=e.substring(0,t).lastIndexOf("{{");if(-1===a)return null;const s=e.substring(a,t);if(s.includes("}}"))return null;const n=s.substring(2),i={isInsideCBS:!0,isBlockFunction:!1,isClosingTag:!1,isSpecialKeyword:!1,currentInput:n,functionName:null};n.startsWith("#")?(i.isBlockFunction=!0,i.currentInput=n.substring(1)):n.startsWith("/")?(i.isClosingTag=!0,i.currentInput=n.substring(1)):n.startsWith(":")&&(i.isSpecialKeyword=!0,i.currentInput=n.substring(1));const r=n.indexOf("::"),o=n.indexOf(" ");let l=n.length;return-1!==r&&(-1===o||r<o)?l=r:-1!==o&&(l=o),i.functionName=n.substring(0,l).replace(/^[#/:]+/,"").trim(),i},findBracketPairs:function(e){const t=[],a=[];let s=0;for(let n=0;n<e.length-1;n++)if("{"===e[n]&&"{"===e[n+1])a.push({position:n,level:s}),s++,n++;else if("}"===e[n]&&"}"===e[n+1]){if(a.length>0){const e=a.pop();s--,t.push({openStart:e.position,openEnd:e.position+2,closeStart:n,closeEnd:n+2,level:e.level})}n++}return t},findFunctionCall:function(e,t){const a=e.substring(0,t).lastIndexOf("{{");if(-1===a)return null;const s=e.substring(a,t);if(s.includes("}}"))return null;let n=s.substring(2).replace(/^[#/:]+/,"");const i=n.indexOf("::");if(-1===i||t<=a+2+i)return null;const r=n.substring(0,i).trim(),o=n.substring(i+2);let l=0,c=0;for(let e=0;e<o.length-1;e++)"{"===o[e]&&"{"===o[e+1]?(c++,e++):"}"===o[e]&&"}"===o[e+1]?(c--,e++):0===c&&":"===o[e]&&":"===o[e+1]&&(l++,e++);return{functionName:r,argumentCount:l}}};"undefined"!=typeof window&&(window.CBSDatabase=CBSDatabase,window.CBSParser=CBSParser);class CBSHighlighter{constructor(e){this.textarea=e,this.container=null,this.overlay=null,this.originalPaddingBottom=0,this.colors=["#FFD70066","#FF6B9D66","#4EC9B066","#C586C066","#569CD666","#CE917866"],this.initialize()}initialize(){const e=window.getComputedStyle(this.textarea);this.container=document.createElement("div"),this.container.className="cbs-highlighter-container",this.container.style.cssText="\n      position: relative;\n      display: inline-block;\n      height: inherit;\n      width: 100%;\n    ",this.overlay=document.createElement("div"),this.overlay.className="cbs-highlighter-overlay",this.overlay.style.cssText=`\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      pointer-events: none;\n      overflow: hidden;\n      white-space: pre-wrap;\n      word-wrap: break-word;\n      overflow-wrap: break-word;\n      font: inherit;\n      padding: inherit;\n      border: inherit;\n      margin: 0;\n      color: ${e.color};\n    `,this.textarea.parentNode.insertBefore(this.container,this.textarea),this.container.appendChild(this.overlay),this.container.appendChild(this.textarea),this.originalTextareaColor=e.color,this.originalTextareaCaretColor=e.caretColor,this.originalBackground=e.backgroundColor,this.textarea.style.position="relative",this.textarea.style.background="transparent",this.textarea.style.zIndex="2",this.textarea.style.caretColor=this.originalTextareaCaretColor,this.container.style.background=this.originalBackground,this.container.style.height="inherit",this.syncStyles(),this.textarea.addEventListener("scroll",()=>this.syncScroll()),this.textarea.addEventListener("input",()=>this.syncOverlayHeight()),window.addEventListener("resize",()=>{this.syncStyles(),this.syncOverlayHeight()})}syncStyles(){const e=window.getComputedStyle(this.textarea);this.overlay.style.fontFamily=e.fontFamily,this.overlay.style.fontSize=e.fontSize,this.overlay.style.fontWeight=e.fontWeight,this.overlay.style.fontStyle=e.fontStyle,this.overlay.style.lineHeight=e.lineHeight,this.overlay.style.letterSpacing=e.letterSpacing,this.overlay.style.wordSpacing=e.wordSpacing,this.overlay.style.textTransform=e.textTransform,this.overlay.style.textIndent=e.textIndent,this.overlay.style.boxSizing=e.boxSizing,this.overlay.style.paddingTop=e.paddingTop,this.overlay.style.paddingRight=e.paddingRight,this.overlay.style.paddingLeft=e.paddingLeft,this.originalPaddingBottom=parseFloat(e.paddingBottom)||0,this.overlay.style.paddingBottom=e.paddingBottom,this.overlay.style.borderTopWidth=e.borderTopWidth,this.overlay.style.borderRightWidth=e.borderRightWidth,this.overlay.style.borderBottomWidth=e.borderBottomWidth,this.overlay.style.borderLeftWidth=e.borderLeftWidth,this.overlay.style.borderStyle="solid",this.overlay.style.borderColor="transparent"}syncScroll(){this.overlay.scrollTop=this.textarea.scrollTop,this.overlay.scrollLeft=this.textarea.scrollLeft}highlight(){const e=this.textarea.value,t=CBSParser.findBracketPairs(e);if(0===t.length)return this.overlay.innerHTML=this.renderText(e),void this.syncOverlayHeight();let a="",s=0;const n=t.sort((e,t)=>e.openStart-t.openStart),i=[];for(const e of n)i.push({start:e.openStart,end:e.openEnd,level:e.level,type:"open"}),i.push({start:e.closeStart,end:e.closeEnd,level:e.level,type:"close"});i.sort((e,t)=>e.start-t.start);for(const t of i){t.start>s&&(a+=this.renderText(e.substring(s,t.start)));const n=t.level%this.colors.length,i=e.substring(t.start,t.end);a+=`<span style="background-color: ${this.colors[n]}; border-radius: 2px;">${this.renderText(i)}</span>`,s=t.end}s<e.length&&(a+=this.renderText(e.substring(s))),this.overlay.innerHTML=a,this.syncOverlayHeight(),this.syncScroll()}syncOverlayHeight(){requestAnimationFrame(()=>{const e=this.textarea.scrollHeight-this.overlay.scrollHeight;this.overlay.style.paddingBottom=e>0?`${this.originalPaddingBottom+e}px`:`${this.originalPaddingBottom}px`})}renderText(e){return this.escapeHTML(e)}escapeHTML(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}destroy(){if(this.container&&this.container.parentNode){const e=this.container.parentNode;e.insertBefore(this.textarea,this.container),e.removeChild(this.container),this.textarea.style.background="",this.textarea.style.position="",this.textarea.style.zIndex="",this.textarea.style.color="",this.textarea.style.caretColor=""}}}"undefined"!=typeof window&&(window.CBSHighlighter=CBSHighlighter);class CBSAutocomplete{constructor(e){this.textarea=e,this.dropdown=null,this.currentItems=[],this.selectedIndex=0,this.isVisible=!1,this.triggerPosition=0,this.handleCursorChange=this.handleCursorChange.bind(this),this.handleDocumentClick=this.handleDocumentClick.bind(this),this.initialize()}initialize(){this.dropdown=document.createElement("div"),this.dropdown.className="cbs-autocomplete-dropdown",this.dropdown.style.cssText="\n      position: absolute;\n      display: none;\n      background: white;\n      border: 1px solid #ccc;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n      max-height: 300px;\n      min-width: 300px;\n      overflow-y: auto;\n      z-index: 10000;\n      border-radius: 4px;\n    ",document.body.appendChild(this.dropdown),this.dropdown.addEventListener("mousedown",e=>{e.preventDefault()}),this.dropdown.addEventListener("click",e=>{const t=e.target.closest(".cbs-autocomplete-item");if(t){const e=parseInt(t.dataset.index,10);this.selectedIndex=e,this.insertSelected()}}),this.textarea.addEventListener("keyup",this.handleCursorChange),this.textarea.addEventListener("click",this.handleCursorChange),this.textarea.addEventListener("input",this.handleCursorChange),document.addEventListener("click",this.handleDocumentClick)}show(e){const t=CBSParser.findCBSContext(this.textarea.value,this.textarea.selectionStart);t&&t.isInsideCBS?(this.currentItems=this.getCompletions(t,e),0!==this.currentItems.length?(this.selectedIndex=0,this.triggerPosition=this.textarea.selectionStart,this.render(),this.position(),this.isVisible=!0):this.hide()):this.hide()}getCompletions(e,t){const a=[],s=CBSDatabase.getAllFunctions(),n=e.currentInput.toLowerCase();for(const t of s){const s=t.name.toLowerCase();if(e.isBlockFunction&&!s.startsWith("#"))continue;if(e.isSpecialKeyword&&!s.startsWith(":"))continue;const i=s.replace(/^[#:]+/,""),r=n.replace(/^[#:]+/,"");if(i.includes(r)||t.aliases.some(e=>e.toLowerCase().includes(r))){let e=0;i.startsWith(r)?e=100:i.includes(r)&&(e=50),a.push({label:t.name.replace(/^#/,""),detail:t.description,insertText:this.generateInsertText(t),args:t.arguments,example:t.example,priority:e,isBlock:t.name.startsWith("#")})}}return a.sort((e,t)=>e.priority!==t.priority?t.priority-e.priority:e.label.localeCompare(t.label)),a}generateInsertText(e){const t=e.name.replace(/^#/,"");return 0===e.arguments.length||e.name.startsWith("#")||e.name.startsWith("//")||e.name.startsWith("?")?t:t+"::"}render(){let e="";for(let t=0;t<this.currentItems.length;t++){const a=this.currentItems[t];e+=`\n        <div class="cbs-autocomplete-item ${t===this.selectedIndex?"selected":""}" data-index="${t}">\n          <div class="cbs-autocomplete-label">\n            ${a.isBlock?'<span class="cbs-block-badge">#</span>':""}\n            <strong>${this.escapeHTML(a.label)}</strong>\n            ${a.args.length>0?`<span class="cbs-args">(${this.escapeHTML(a.args.join(", "))})</span>`:""}\n          </div>\n          <div class="cbs-autocomplete-detail">${this.escapeHTML(a.detail)}</div>\n        </div>\n      `}this.dropdown.innerHTML=e}position(){const e=this.textarea.value.substring(0,this.textarea.selectionStart).split("\n"),t=e.length-1,a=e[e.length-1].length,s=window.getComputedStyle(this.textarea),n=parseFloat(s.fontSize),i=parseFloat(s.lineHeight)||1.5*n,r=parseFloat(s.paddingLeft),o=parseFloat(s.paddingTop),l=this.textarea.getBoundingClientRect(),c=.6*n;let m=l.left+r+a*c-this.textarea.scrollLeft,d=l.top+o+t*i+i-this.textarea.scrollTop;const p=Math.min(300,60*this.currentItems.length);m+300>window.innerWidth&&(m=window.innerWidth-300-10),d+p>window.innerHeight&&(d=l.top-p-5),this.dropdown.style.left=`${m}px`,this.dropdown.style.top=`${d}px`,this.dropdown.style.display="block"}hide(){this.dropdown.style.display="none",this.isVisible=!1,this.currentItems=[],this.selectedIndex=0}selectNext(){this.isVisible&&(this.selectedIndex=(this.selectedIndex+1)%this.currentItems.length,this.render(),this.scrollToSelected())}selectPrev(){this.isVisible&&(this.selectedIndex=(this.selectedIndex-1+this.currentItems.length)%this.currentItems.length,this.render(),this.scrollToSelected())}scrollToSelected(){const e=this.dropdown.querySelectorAll(".cbs-autocomplete-item");e[this.selectedIndex]&&e[this.selectedIndex].scrollIntoView({block:"nearest"})}insertSelected(){if(!this.isVisible||0===this.currentItems.length)return;const e=this.currentItems[this.selectedIndex],t=this.textarea.value,a=this.textarea.selectionStart,s=t.substring(0,a).lastIndexOf("{{");if(-1===s)return;const n=t.substring(s+2,a),i=s+2;let r="";n.startsWith("#")?r="#":n.startsWith(":")&&(r=":");const o=t.substring(0,i),l=t.substring(a),c=o+r+e.insertText+l;this.textarea.value=c;const m=i+r.length+e.insertText.length;this.textarea.selectionStart=m,this.textarea.selectionEnd=m,this.textarea.dispatchEvent(new Event("input",{bubbles:!0})),this.hide(),this.textarea.focus()}onKeyDown(e){if(!this.isVisible)return!1;switch(e.key){case"ArrowDown":return e.preventDefault(),this.selectNext(),!0;case"ArrowUp":return e.preventDefault(),this.selectPrev(),!0;case"Enter":case"Tab":return e.preventDefault(),this.insertSelected(),!0;case"Escape":return e.preventDefault(),this.hide(),!0;default:return!1}}escapeHTML(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}handleCursorChange(e){if(!this.isVisible)return;const t=CBSParser.findCBSContext(this.textarea.value,this.textarea.selectionStart);t&&t.isInsideCBS||this.hide()}handleDocumentClick(e){this.isVisible&&(this.dropdown.contains(e.target)||this.textarea.contains(e.target)||this.hide())}destroy(){this.textarea.removeEventListener("keyup",this.handleCursorChange),this.textarea.removeEventListener("click",this.handleCursorChange),this.textarea.removeEventListener("input",this.handleCursorChange),document.removeEventListener("click",this.handleDocumentClick),this.dropdown&&this.dropdown.parentNode&&this.dropdown.parentNode.removeChild(this.dropdown)}}"undefined"!=typeof window&&(window.CBSAutocomplete=CBSAutocomplete);class CBSSignature{constructor(e){this.textarea=e,this.tooltip=null,this.isVisible=!1,this.currentSignature=null,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleDocumentClick=this.handleDocumentClick.bind(this),this.handleCursorChange=this.handleCursorChange.bind(this),this.initialize()}initialize(){this.tooltip=document.createElement("div"),this.tooltip.className="cbs-signature-tooltip",this.tooltip.style.cssText="\n      position: absolute;\n      display: none;\n      background: white;\n      color: #333;\n      border: 1px solid #ccc;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n      padding: 8px 12px;\n      z-index: 10001;\n      border-radius: 4px;\n      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;\n      font-size: 13px;\n      max-width: 500px;\n      line-height: 1.4;\n    ",document.body.appendChild(this.tooltip),this.tooltip.addEventListener("mousedown",e=>{e.preventDefault()}),document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("click",this.handleDocumentClick),this.textarea.addEventListener("keyup",this.handleCursorChange),this.textarea.addEventListener("click",this.handleCursorChange),this.textarea.addEventListener("input",this.handleCursorChange)}getSignatureHelp(e,t){const a=this.findFunctionCall(e,t);if(!a)return null;const s=CBSDatabase.getFunctionInfo(a.functionName);if(!s)return null;const n=this.calculateActiveParameter(a);return this.buildSignatureInfo(s,n)}findFunctionCall(e,t){const a=e.substring(0,t).lastIndexOf("{{");if(-1===a)return null;const s=e.substring(a,t);if(s.includes("}}"))return null;let n=s.substring(2);n=n.replace(/^[#/:]+/,"");return this.findInnermostFunction(n,t-a-2)||this.parseFunctionCall(n,t-a-2)}findInnermostFunction(e,t){let a=0,s=-1;for(let n=0;n<Math.min(e.length,t);n++)n<e.length-1&&"{"===e[n]&&"{"===e[n+1]?(s=n,a++,n++):n<e.length-1&&"}"===e[n]&&"}"===e[n+1]&&(a--,n++);if(-1!==s&&a>0){const a=e.substring(s+2),n=t-s-2,i=a.replace(/^[#/:]+/,""),r=a.length-i.length;return this.parseFunctionCall(i,n-r)}return null}parseFunctionCall(e,t){const a=e.indexOf("::");if(-1===a)return null;if(t<=a)return null;const s=e.substring(0,a).trim(),n=e.substring(a+2,t);return{functionName:s,argumentText:n,cursorPositionInArgs:t-a-2,argumentCount:this.countArguments(n)}}countArguments(e){if(""===e.trim())return 0;let t=0,a=0;for(let s=0;s<e.length-1;s++)"{"===e[s]&&"{"===e[s+1]?(a++,s++):"}"===e[s]&&"}"===e[s+1]?(a--,s++):0===a&&":"===e[s]&&":"===e[s+1]&&(t++,s++);return t}calculateActiveParameter(e){return Math.max(0,e.argumentCount)}buildSignatureInfo(e,t){const a=e.arguments.map(t=>({label:t,documentation:this.getParameterDocumentation(e.name,t)})),s=e.arguments.join(", "),n=`${e.name}(${s})`,i=Math.min(t,a.length-1);return{label:n,documentation:this.formatFunctionDocumentation(e),parameters:a,activeParameter:Math.max(0,i)}}getParameterDocumentation(e,t){return{name:"변수 또는 항목의 이름",value:"설정할 값",string:"문자열 값",target:"찾을 대상 문자열",replacement:"대체할 문자열",array:"배열 또는 리스트",index:"배열 인덱스 (0부터 시작)",condition:"조건식 (1 또는 true가 참)",expression:"수학 표현식",format:"날짜/시간 형식 문자열",timestamp:"유닉스 타임스탬프",a:"첫 번째 값",b:"두 번째 값",delimiter:"구분자 문자열",arg1:"첫 번째 인자",arg2:"두 번째 인자",arg3:"세 번째 인자",number:"숫자 값",min:"최소값",max:"최대값",start:"시작 위치",end:"끝 위치",key:"키 이름",prefix:"접두사 문자열",suffix:"접미사 문자열",substring:"부분 문자열",base:"밑수",exponent:"지수",decimals:"소수점 자리수",NdM:"주사위 표기법 (예: 2d6)",hex:"16진수 값",code:"유니코드 코드",size:"크기 값",label:"레이블 텍스트",action:"실행할 동작",text:"텍스트 내용",operator:"연산자 (and, or, is, not 등)",namespace:"네임스페이스 또는 모듈 이름",type:"타입 또는 종류",dict:"딕셔너리/객체",json:"JSON 데이터",key1:"첫 번째 키",key2:"두 번째 키"}[t]||`${t} 인자`}formatFunctionDocumentation(e){let t=e.description;return e.example&&(t+=`\n\n예제: ${e.example}`),t}show(){const e=this.textarea.value,t=this.textarea.selectionStart,a=this.getSignatureHelp(e,t);a?(this.currentSignature=a,this.render(),this.position(),this.isVisible=!0):this.hide()}render(){if(!this.currentSignature)return;const{label:e,documentation:t,parameters:a,activeParameter:s}=this.currentSignature;let n='<div class="cbs-signature-main">';n+='<div class="cbs-signature-label">';const i=e.indexOf("("),r=e.substring(0,i),o=e.substring(i+1,e.length-1).split(", ");if(n+=`<span class="cbs-func-name">${this.escapeHTML(r)}</span>(`,o.forEach((e,t)=>{t>0&&(n+=", "),n+=t===s?`<span class="cbs-active-param">${this.escapeHTML(e)}</span>`:`<span class="cbs-param">${this.escapeHTML(e)}</span>`}),n+=")",n+="</div>",t&&(n+=`<div class="cbs-signature-doc">${this.escapeHTML(t)}</div>`),a[s]){const e=a[s].documentation;n+='<div class="cbs-param-doc">',n+=`<strong>${this.escapeHTML(a[s].label)}</strong>: `,n+=this.escapeHTML(e),n+="</div>"}n+="</div>",this.tooltip.innerHTML=n}position(){const e=this.textarea.value.substring(0,this.textarea.selectionStart).split("\n"),t=e.length-1,a=e[e.length-1].length,s=window.getComputedStyle(this.textarea),n=parseFloat(s.fontSize),i=parseFloat(s.lineHeight)||1.5*n,r=parseFloat(s.paddingLeft),o=parseFloat(s.paddingTop),l=this.textarea.getBoundingClientRect(),c=.6*n;let m=l.left+r+a*c-this.textarea.scrollLeft,d=l.top+o+t*i-i-this.textarea.scrollTop;const p=this.tooltip.getBoundingClientRect(),h=p.width||300;p.height,m+h>window.innerWidth&&(m=window.innerWidth-h-10),d<0&&(d=l.top+o+t*i+i),this.tooltip.style.left=`${m}px`,this.tooltip.style.top=`${d}px`,this.tooltip.style.display="block"}hide(){this.tooltip.style.display="none",this.isVisible=!1,this.currentSignature=null}escapeHTML(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}handleKeyDown(e){"Escape"===e.key&&this.isVisible&&(this.hide(),e.preventDefault())}handleDocumentClick(e){this.isVisible&&(this.tooltip.contains(e.target)||this.textarea.contains(e.target)||this.hide())}handleCursorChange(e){if(!this.isVisible)return;const t=this.textarea.value,a=this.textarea.selectionStart;this.getSignatureHelp(t,a)||this.hide()}destroy(){document.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("click",this.handleDocumentClick),this.textarea.removeEventListener("keyup",this.handleCursorChange),this.textarea.removeEventListener("click",this.handleCursorChange),this.textarea.removeEventListener("input",this.handleCursorChange),this.tooltip&&this.tooltip.parentNode&&this.tooltip.parentNode.removeChild(this.tooltip)}}"undefined"!=typeof window&&(window.CBSSignature=CBSSignature);"undefined"!=typeof window&&(window.CBSTextarea=class CBSTextarea{constructor(e,t={}){if(!e||"TEXTAREA"!==e.tagName)throw new Error("CBSTextarea requires a textarea element");this.textarea=e,this.options={highlightEnabled:!0,autocompleteEnabled:!0,signatureEnabled:!0,...t},this.highlighter=null,this.autocomplete=null,this.signature=null,this.initialize()}initialize(){this.options.highlightEnabled&&(this.highlighter=new CBSHighlighter(this.textarea)),this.options.autocompleteEnabled&&(this.autocomplete=new CBSAutocomplete(this.textarea)),this.options.signatureEnabled&&(this.signature=new CBSSignature(this.textarea)),this.attachEvents(),this.highlighter&&this.highlighter.highlight()}attachEvents(){this.textarea.addEventListener("input",e=>{if(this.highlighter&&this.highlighter.highlight(),this.autocomplete){const e=this.textarea.value,t=this.textarea.selectionStart;if(t>=2){const a=e.substring(t-2,t),s=t>=3?e.substring(t-3,t):"";if("{{"===a||"{{#"===s||"{{:"===s||"{{/"===s)this.autocomplete.show(a);else if(t>=1){const a=CBSParser.findCBSContext(e,t);a&&a.isInsideCBS&&this.autocomplete.show()}}}if(this.signature){const e=this.textarea.value,t=this.textarea.selectionStart;if(t>=2){const a=e.substring(t-2,t);if("::"===a||a.endsWith(":"))this.signature.show();else{const a=CBSParser.findCBSContext(e,t);a&&a.isInsideCBS&&a.currentInput.includes("::")?this.signature.show():this.signature.hide()}}}}),this.textarea.addEventListener("keydown",e=>{this.autocomplete&&this.autocomplete.isVisible&&this.autocomplete.onKeyDown(e)}),this.textarea.addEventListener("blur",()=>{setTimeout(()=>{this.autocomplete&&this.autocomplete.hide(),this.signature&&this.signature.hide()},200)}),window.addEventListener("resize",()=>{this.highlighter&&this.highlighter.highlight()}),this.textarea.addEventListener("scroll",()=>{this.autocomplete&&this.autocomplete.isVisible&&this.autocomplete.position(),this.signature&&this.signature.isVisible&&this.signature.position()})}enable(e){"highlight"!==e||this.highlighter?"autocomplete"!==e||this.autocomplete?"signature"!==e||this.signature||(this.options.signatureEnabled=!0,this.signature=new CBSSignature(this.textarea)):(this.options.autocompleteEnabled=!0,this.autocomplete=new CBSAutocomplete(this.textarea)):(this.options.highlightEnabled=!0,this.highlighter=new CBSHighlighter(this.textarea),this.highlighter.highlight())}disable(e){"highlight"===e&&this.highlighter?(this.options.highlightEnabled=!1,this.highlighter.destroy(),this.highlighter=null):"autocomplete"===e&&this.autocomplete?(this.options.autocompleteEnabled=!1,this.autocomplete.destroy(),this.autocomplete=null):"signature"===e&&this.signature&&(this.options.signatureEnabled=!1,this.signature.destroy(),this.signature=null)}refresh(){this.highlighter&&this.highlighter.highlight()}destroy(){this.highlighter&&this.highlighter.destroy(),this.autocomplete&&this.autocomplete.destroy(),this.signature&&this.signature.destroy()}})}(),"undefined"!=typeof module&&module.exports&&(module.exports=window.CBSTextarea);